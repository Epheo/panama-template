
# OpenStack definition model for Shaddock.
# ========================================

---

clusters:


  - name: openstack-upstream
    vars: !include vars/default.yml
    hosts: !include hosts/all.yml
    images: images/region1/
    services:

      - name: rabbitmq
        image: 'shaddock/rabbitmq:{{ img_tag }}'
        host: node001
        priority: 10
        ports:
          - 5672:5672
          - 15672:15672
        volumes:
          - /data/log:/var/log/shaddock/mysql:rw
        env:
          RABBIT_PASS: '{{ def_password }}'

      - name: mysql
        image: 'shaddock/mysql:{{ img_tag }}'
        host: node001
        priority: 20
        ports:
          - 3306:3306
        volumes:
          - /var/log/mysql:/var/log/shaddock/mysql:rw
        env:
          MYSQL_USER: '{{ mysql_admin_user }}'
          MYSQL_PASSWORD: '{{ mysql_password }}'

      - name: keystone
        image: 'shaddock/keystone:{{ img_tag }}'
        host: node001
        priority: 30
        ports:
          35357: 35357
          5000: 5000
        volumes:
          - /var/log/keystone:/var/log/shaddock/keystone:rw
          - /opt/openstack:/opt/openstack:rw
        depends-on:
          - {name: mysql, port: 3306}
        env:
          MYSQL_HOST_IP: '{{ mysql_vip }}'
          MYSQL_USER: '{{ mysql_admin_user }}'
          MYSQL_PASSWORD: '{{ mysql_password }}'
          KEYSTONE_API_IP: '{{ keystone_api_ip }}'
          KEYSTONE_DBPASS: '{{ def_password }}'
          ADMIN_TOKEN: '{{ def_password }}'

      - name: glance
        image: 'shaddock/glance:{{ img_tag }}'
        host: node001
        priority: 40
        ports:
          - 9292:9292
          - 9191:9191
        volumes:
          - /var/log/glance:/var/log/shaddock/glance:rw
          - /opt/openstack:/opt/openstack:rw
        depends-on:
          - {name: seed, status: stopped}
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          MYSQL_HOST_IP: '{{ mysql_vip }}'
          MYSQL_USER: '{{ mysql_admin_user }}'
          MYSQL_PASSWORD: '{{ mysql_password }}'
          KEYSTONE_API_IP: '{{ keystone_api_ip }}'
          GLANCE_API_IP: '{{ glance_api_ip }}'
          GLANCE_DBPASS: '{{ def_password }}'
          GLANCE_PASS: '{{ def_password }}'
          ADMIN_PASS: '{{ def_password }}'

      - name: nova
        image: 'shaddock/nova:{{ img_tag }}'
        host: node001
        priority: 45
        ports:
          - 8774:8774
        privileged: True
        volumes:
          - /var/log/nova:/var/log/shaddock/nova:rw
          - /opt/openstack:/opt/openstack:rw
        depends-on:
          - {name: seed, status: stopped}
          - {name: mysql, port: 3306}
          - {name: rabbitmq, port: 5672}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          MYSQL_HOST_IP: '{{ mysql_vip }}'
          MYSQL_USER: '{{ mysql_admin_user }}'
          MYSQL_PASSWORD: '{{ mysql_password }}'
          KEYSTONE_API_IP: '{{ public_vip }}'
          RABBIT_HOST_IP: '{{ public_vip }}'
          RABBIT_PASS: '{{ def_password }}'
          GLANCE_API_IP: '{{ public_vip }}'
          NEUTRON_API_IP: '{{ public_vip }}'
          NOVA_API_IP: '{{ public_vip }}'
          NOVA_DBPASS: '{{ def_password }}'
          NOVA_PASS: '{{ def_password }}'
          ADMIN_PASS: '{{ def_password }}'

      - name: horizon
        image: 'shaddock/horizon:{{ img_tag }}'
        host: node001
        priority: 50
        ports:
          - 80:8010
          - 11211:11211
        volumes:
          - /var/log/horizon:/var/log/shaddock/horizon:rw
          - /opt/openstack:/opt/openstack:rw
        depends-on:
          - {name: seed, status: stopped}
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          KEYSTONE_API_IP: '{{ public_vip }}'

      - name: cinder
        image: 'shaddock/cinder:{{ img_tag }}'
        host: node001
        priority: 60
        ports:
          - 8776:8776
        volumes:
          - /var/log/cinder:/var/log/shaddock/cinder:rw
          - /opt/openstack:/opt/openstack:rw
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          MYSQL_HOST_IP: '{{ mysql_vip }}'
          MYSQL_USER: '{{ mysql_admin_user }}'
          MYSQL_PASSWORD: '{{ mysql_password }}'
          KEYSTONE_API_IP: '{{ public_vip }}'
          RABBIT_HOST_IP: '{{ public_vip }}'
          RABBIT_PASS: '{{ def_password }}'
          CINDER_API_IP: '{{ public_vip }}'
          CINDER_DBPASS: '{{ def_password }}'
          CINDER_PASS: '{{ def_password }}'
          ADMIN_PASS: '{{ def_password }}'

      - name: cinder-volume
        image: 'shaddock/cinder-volume:{{ img_tag }}'
        host: node001
        priority: 65
        volumes:
          - /var/log/cinder:/var/log/shaddock/volume:rw
          - /sys:/sys:ro
          - /dev:/dev
          - /var/run::/var/run
          - /opt/openstack:/opt/openstack:rw
        privileged: True
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
          - {name: cinder}
        env:
          MYSQL_HOST_IP: '{{ mysql_vip }}'
          KEYSTONE_API_IP: '{{ public_vip }}'
          RABBIT_HOST_IP: '{{ public_vip }}'
          RABBIT_PASS: '{{ def_password }}'
          GLANCE_API_IP: '{{ public_vip }}'
          CINDER_API_IP: '{{ public_vip }}'
          CINDER_DBPASS: '{{ def_password }}'
          CINDER_PASS: '{{ def_password }}'

      - name: nova-qemu
        image: 'shaddock/nova-qemu:{{ img_tag }}'
        host: node001
        priority: 90
        ports:
          - 8775:8775
        volumes:
          - /var/log/nova:/var/log/shaddock/compute:rw
          - /lib/modules:/lib/modules:ro
          - /opt/openstack:/opt/openstack:rw
        privileged: True
        network_mode: host
        depends-on:
          - {name: nova}
        env:
          KEYSTONE_API_IP: '{{ public_vip }}'
          RABBIT_HOST_IP: '{{ public_vip }}'
          RABBIT_PASS: '{{ def_password }}'
          GLANCE_API_IP: '{{ public_vip }}'
          NEUTRON_API_IP: '{{ public_vip }}'
          NEUTRON_PASS: '{{ def_password }}'
          NOVA_API_IP: '{{ public_vip }}'
          NOVA_PASS: '{{ def_password }}'

      - name: heat
        image: 'shaddock/heat:{{ img_tag }}'
        host: node001
        priority: 100
        ports:
          - 8000:8000
          - 8004:8004
        volumes:
          - /var/log/heat:/var/log/shaddock/heat:rw
          - /opt/openstack:/opt/openstack:rw
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          MYSQL_HOST_IP: '{{ mysql_vip }}'
          MYSQL_USER: '{{ mysql_admin_user }}'
          MYSQL_PASSWORD: '{{ mysql_password }}'
          KEYSTONE_API_IP: '{{ public_vip }}'
          RABBIT_HOST_IP: '{{ public_vip }}'
          RABBIT_PASS: '{{ def_password }}'
          HEAT_API_IP: '{{ public_vip }}'
          HEAT_DBPASS: '{{ def_password }}'
          HEAT_PASS: '{{ def_password }}'
          ADMIN_PASS: '{{ def_password }}'

  - name: base
    images: images/region1/
    services:
      - name: seed
        image: 'shaddock/seed:arch_based'
        priority: 0
