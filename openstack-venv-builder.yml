
# UpStrean OpenStack VirtualEnv builder
# =====================================

---

clusters: 

  - name: venv-builder
    hosts: !include hosts/all.yml

    vars:
      builder_img: 'shaddock/generic-pyvenv-builder:latest'
      git_repo: 'https://github.com/openstack/'
      git_branch: 'stable/newton'
      services_list:
        - 10;python-neutronclient
        - 10;python-glanceclient
        - 10;python-keystoneclient
        - 10;python-cinderclient
        - 10;python-opensckclient
        - 10;python-novaclient
        - 19;nova
        - 20;glance
        - 20;keystone
        - 20;cinder
        - 20;neutron
        - 20;horizon
        - 20;heat

    images: images/venv-builder/

    services: | 
        {% for service in services_list %}
        - name: "{{service.split(';')[1]}}-builder"
          image: {{ builder_img }}
          priority: {{ service.split(';')[0] }}
          volumes:
            - /opt/openstack:/opt/openstack:rw
          env:
            GIT_URL: "{{ git_repo }}{{service.split(';')[1]}}.git"
            GIT_BRANCH: {{ git_branch }}
        {% endfor %}

        - name: symlink-creator
          image: '{{ builder_img }}'
          priority: 30
          volumes:
            /opt/openstack: {'bind': '/opt/openstack','mode': 'rw'}
          depends-on:
            {% for service in services_list %}
            - name: "{{service.split(';')[1]}}-builder"
              status: stopped
              retry: 100
              sleep: 40
            {% endfor %}
          command: "create_symlinks.sh"

        - name: venv-fixer
          image: '{{ builder_img }}'
          priority: 35
          volumes:
            - /opt/openstack:/opt/openstack:rw
          depends-on:
            - {name: symlink-creator, status: stopped} 
          command: "openstack-venv-fix.sh"
