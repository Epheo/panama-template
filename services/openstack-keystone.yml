---

name: openstack-keystone
image-path: images/openstack
containers:

  - name: keystone-configure
    image: 'shaddock/keystone:{{ img_tag }}'
    priority: 30
    volumes:
      - '{{ venv_build_path }}:{{ venv_build_path }}:rw'
      - '{{ venv_exec_path }}/keystone/etc:/etc/keystone:rw'
      - '{{ venv_exec_path }}/keystone:{{ venv_exec_path }}/keystone:rw'
    depends-on:
      - {name: mysql, port: 3306}
    environment:
      MYSQL_VIP: '{{ mysql_vip }}'
      MYSQL_USER: '{{ mysql_user }}'
      MYSQL_PASS: '{{ mysql_pass }}'
      KEYSTONE_VIP: '{{ keystone_vip }}'
      KEYSTONE_DB_PASS: '{{ keystone_db_pass }}'
      ADMIN_PASS: '{{ admin_pass }}'
      PATH: '/usr/bin:/bin:{{ venv_exec_path }}/keystone/bin'

  - name: keystone-admin
    image: 'shaddock/keystone:{{ img_tag }}'
    priority: 31
    ports: { '35357/tcp':35357 }
    volumes:
      - '{{ venv_build_path }}:{{ venv_build_path }}:ro'
      - '{{ venv_exec_path }}/keystone:{{ venv_exec_path }}/keystone:ro'
      - '{{ venv_exec_path }}/keystone/etc:/etc/keystone:ro'
      - '/var/log/shaddock/keystone:/var/log/keystone:rw'
    depends-on:
      - {name: keystone-configure, status: stopped}
    environment:
      PATH: '/usr/bin:/bin:{{ venv_exec_path }}/keystone/bin'
      VIRTUAL_ENV: '{{ venv_exec_path }}/keystone/'
    command: 'keystone-wsgi-admin --host 0.0.0.0 --port 35357'

  - name: keystone-public
    image: 'shaddock/keystone:{{ img_tag }}'
    priority: 31
    ports: { '5000/tcp':5000 }
    volumes:
      - '{{ venv_build_path }}:{{ venv_build_path }}:ro'
      - '{{ venv_exec_path }}/keystone:{{ venv_exec_path }}/keystone:ro'
      - '{{ venv_exec_path }}/keystone/etc:/etc/keystone:ro'
      - /var/log/shaddock/keystone:/var/log/keystone:rw
    depends-on:
      - {name: keystone-configure, status: stopped}
    environment:
      PATH: '/usr/bin:/bin:{{ venv_exec_path }}/keystone/bin'
      VIRTUAL_ENV: '{{ venv_exec_path }}/keystone/'
    command: 'keystone-wsgi-public --host 0.0.0.0 --port 5000'
    
