# OpenStack definition model for Shaddock.
# ========================================
#

---

clusters:

  - name: openstack-ubuntu-mitaka
    images: images/ubuntu-mitaka
    hosts: !include hosts/all.yml
    vars:
      default_passwd: T7pqrQGbNViV164c
      mysql_passwd: VD486ByNgjv7esYa
      host_ip: 172.17.0.1
      image_tag: ubuntu-mitaka

    services:     
      - name: rabbitmq
        image: 'shaddock/rabbitmq:{{ image_tag }}'
        host: node001
        priority: 10
        ports:
          - 5672:5672
          - 15672:15672
        volumes:
          - /var/log/shaddock/rabbitmq/log:/data/log
        env:
          RABBIT_PASS: '{{ default_passwd }}'

      - name: mysql
        image: 'shaddock/mysql:{{ image_tag }}'
        host: node001
        priority: 20
        ports:
          - 3306:3306
        volumes:
          - /var/log/shaddock/mysql:/var/log/mysql
        env:
          MYSQL_USER: admin
          MYSQL_PASSWORD: '{{ mysql_passwd }}'

      - name: keystone
        image: 'shaddock/keystone:{{ image_tag }}'
        priority: 30
        ports:
          - 35357:35357
          - 5000:5000
        volumes:
          - /var/log/shaddock/keystone:/var/log/keystone
        depends-on:
          - {name: mysql, port: 3306}
        env:
          MYSQL_HOST_IP: '{{ host_ip }}'
          MYSQL_USER: admin
          MYSQL_PASSWORD: '{{ mysql_passwd }}'
          KEYSTONE_DBPASS: '{{ default_passwd }}'
          ADMIN_TOKEN: '{{ default_passwd }}'

      - name: keystone-configure
        image: 'shaddock/keystone-configure'
        priority: 35
        depends-on:
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          KEYSTONE_PASS: '{{ default_passwd }}'
          DEMO_EMAIL: demo.example.org
          DEMO_PASS: '{{ default_passwd }}'
          ADMIN_EMAIL: admin.example.org
          ADMIN_PASS: '{{ default_passwd }}'
          ADMIN_TOKEN: '{{ default_passwd }}'
        command: cloud-config

      - name: glance
        image: 'shaddock/glance:{{ image_tag }}'
        priority: 40
        ports:
          - 9292:9292
          - 9191:9191
        volumes:
          - /var/log/shaddock/glance:/var/log/glance
        depends-on:
          - {name: keystone-configure, status: stopped}
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          MYSQL_HOST_IP: '{{ host_ip }}'
          MYSQL_USER: admin
          MYSQL_PASSWORD: '{{ mysql_passwd }}'
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          GLANCE_HOST_IP: '{{ host_ip }}'
          GLANCE_DBPASS: '{{ default_passwd }}'
          GLANCE_PASS: '{{ default_passwd }}'
          ADMIN_PASS: '{{ default_passwd }}'

      - name: nova
        image: 'shaddock/nova-legacy:{{ image_tag }}'
        priority: 45
        ports:
          - 8774:8774
        privileged: True
        volumes:
          - /var/log/shaddock/nova:/var/log/nova
        depends-on:
          - {name: keystone-configure, status: stopped}
          - {name: mysql, port: 3306}
          - {name: rabbitmq, port: 5672}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          MYSQL_HOST_IP: '{{ host_ip }}'
          MYSQL_USER: admin
          MYSQL_PASSWORD: '{{ mysql_passwd }}'
          RABBIT_HOST_IP: '{{ host_ip }}'
          RABBIT_PASS: '{{ default_passwd }}'
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          NOVA_HOST_IP: '{{ host_ip }}'
          NOVA_DBPASS: '{{ default_passwd }}'
          NOVA_PASS: '{{ default_passwd }}'
          ADMIN_PASS: '{{ default_passwd }}'

      - name: horizon
        image: 'shaddock/horizon:{{ image_tag }}'
        host: node001
        priority: 55
        ports:
          - 80:8010
          - 11211:11211
        volumes:
          - /var/log/shaddock/horizon:/var/log/horizon
        depends-on:
          - {name: keystone-configure, status: stopped}
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          HORIZON_HOST_IP: '{{ host_ip }}'

      - name: cinder
        image: 'shaddock/cinder:{{ image_tag }}'
        priority: 60
        ports:
          - 8776:8776
        volumes:
          - /var/log/shaddock/cinder:/var/log/cinder
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          RABBIT_HOST_IP: '{{ host_ip }}'
          MYSQL_HOST_IP: '{{ host_ip }}'
          MYSQL_USER: admin
          MYSQL_PASSWORD: '{{ mysql_passwd }}'
          ADMIN_PASS: '{{ default_passwd }}'
          CINDER_HOST_IP: '{{ host_ip }}'
          HOST_IP: '{{ host_ip }}'
          RABBIT_PASS: '{{ default_passwd }}'
          CINDER_DBPASS: '{{ default_passwd }}'
          CINDER_PASS: '{{ default_passwd }}'

      - name: cinder-volume
        image: 'shaddock/cinder-volume:{{ image_tag }}'
        priority: 65
        volumes:
          - /var/log/shaddock/volume:/var/log/cinder
          - /sys:/sys:ro
          - /dev:/dev
          - /var/run:/var/run
        privileged: True
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
          - {name: cinder}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          RABBIT_HOST_IP: '{{ host_ip }}'
          MYSQL_HOST_IP: '{{ host_ip }}'
          GLANCE_HOST_IP: '{{ host_ip }}'
          CINDER_HOST_IP: '{{ host_ip }}'
          HOST_IP: '{{ host_ip }}'
          RABBIT_PASS: '{{ default_passwd }}'
          CINDER_DBPASS: '{{ default_passwd }}'
          CINDER_PASS: '{{ default_passwd }}'

      - name: manila
        image: 'shaddock/manila:{{ image_tag }}'
        priority: 70
        ports:
          - 8786:8786
        volumes:
          - /var/log/shaddock/manila:/var/log/manila
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          RABBIT_HOST_IP: '{{ host_ip }}'
          MYSQL_HOST_IP: '{{ host_ip }}'
          MYSQL_USER: admin
          MYSQL_PASSWORD: '{{ mysql_passwd }}'
          ADMIN_PASS: '{{ default_passwd }}'
          MANILA_HOST_IP: '{{ host_ip }}'
          HOST_IP: '{{ host_ip }}'
          RABBIT_PASS: '{{ default_passwd }}'
          MANILA_DBPASS: '{{ default_passwd }}'
          MANILA_PASS: '{{ default_passwd }}'

      - name: manila-share
        image: 'shaddock/manila-share:{{ image_tag }}'
        priority: 75
        volumes:
          - /var/log/shaddock/share:/var/log/manila
          - /sys:/sys:ro 
          - /dev:/dev
          - /var/run:/var/run
        privileged: True
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
          - {name: manila}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          RABBIT_HOST_IP: '{{ host_ip }}'
          MYSQL_HOST_IP: '{{ host_ip }}'
          MANILA_HOST_IP: '{{ host_ip }}'
          HOST_IP: '{{ host_ip }}'
          RABBIT_PASS: '{{ default_passwd }}'
          MANILA_DBPASS: '{{ default_passwd }}'
          MANILA_PASS: '{{ default_passwd }}'

      - name: nova-qemu
        image: 'shaddock/nova-legacy-qemu:{{ image_tag }}'
        priority: 90
        ports:
          - 8775:8775
        volumes:
          - /var/log/shaddock/compute:/var/log/nova
          - /lib/modules:/lib/modules:ro
        privileged: True
        network_mode: host
        depends-on:
          - {name: nova}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          RABBIT_HOST_IP: '{{ host_ip }}'
          MYSQL_HOST_IP: '{{ host_ip }}'
          NOVA_HOST_IP: '{{ host_ip }}'
          NEUTRON_HOST_IP: '{{ host_ip }}'
          HOST_IP: '{{ host_ip }}'
          RABBIT_PASS: '{{ default_passwd }}'
          NOVA_PASS: '{{ default_passwd }}'
          NEUTRON_PASS: '{{ default_passwd }}'

      - name: heat
        image: 'shaddock/heat:{{ image_tag }}'
        priority: 100
        ports:
          - 8000:8000
          - 8004:8004
        volumes:
          - /var/log/shaddock/heat:/var/log/heat
        depends-on:
          - {name: mysql, port: 3306}
          - {name: keystone, port: 5000, get: '/v3'}
          - {name: keystone, port: 35357, get: '/v3'}
        env:
          KEYSTONE_HOST_IP: '{{ host_ip }}'
          RABBIT_HOST_IP: '{{ host_ip }}'
          RABBIT_PASS: '{{ default_passwd }}'
          MYSQL_HOST_IP: '{{ host_ip }}'
          MYSQL_USER: admin
          MYSQL_PASSWORD: '{{ mysql_passwd }}'
          ADMIN_PASS: '{{ default_passwd }}'
          HOST_IP: '{{ host_ip }}'
          HEAT_HOST_IP: '{{ host_ip }}'
          HEAT_DBPASS: '{{ default_passwd }}'
          HEAT_PASS: '{{ default_passwd }}'

      - name: seed
        image: 'shaddock/seed:{{ image_tag }}'
        priority: 0
